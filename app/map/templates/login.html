{% extends 'base.html' %}
{% block title %}Login{% endblock %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <h2>Login</h2>
        <form id="login-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_username">Username:</label>
                <input type="text" id="id_username" name="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="id_password">Password:</label>
                <input type="password" id="id_password" name="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
        </form>
        <div id="error-message" class="mt-3 text-danger" style="display:none;"></div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const username = document.getElementById('id_username').value;
        const password = document.getElementById('id_password').value;
        const csrfToken = document.cookie
          .split('; ')
          .find(row => row.startsWith('csrftoken='))
          ?.split('=')[1];
        fetch('/api/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ username, password })
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '/map/'; // Redirect to the map
            } else {
                return response.json().then(data => {
                    throw new Error(data.error || 'Login failed');
                });
            }
        })
        .catch(error => {
            document.getElementById('error-message').innerText = error.message;
            document.getElementById('error-message').style.display = 'block';
        });
    });
</script>
{% endblock %}