{% extends 'base.html' %} {% block title %}
  Map
{% endblock %} {% block content %}
  <style>
    #map {
      width: 100%;
      height: 600px;
    }
  </style>

  <h1>Dublin Cycling Map</h1>
  <div id="map"></div>
  <button onclick="updateLocation()">Update Location</button>
{% endblock %} {% block extra_js %}
  <script>
    // Initialize the map
    var map = L.map('map').setView([53.3498, -6.2603], 12) // Centered on Dublin
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map)
    
    // Define styling for cycleways
    function cyclewayStyle(feature) {
      return {
        color: '#3388ff',
        weight: 3,
        opacity: 0.7
      }
    }
    
    function updateMap(latitude, longitude, accuracy) {
      let marker
      if (marker) {
        map.removeLayer(marker)
      }
      marker = L.marker([latitude, longitude]).addTo(map) // Add a marker at the user's location
    }
    
    // Load cycleways GeoJSON
    fetch("{% url 'cycleways_geojson' %}")
      .then((response) => response.json())
      .then((data) => {
        L.geoJSON(data, {
          style: cyclewayStyle,
          onEachFeature: function (feature, layer) {
            let popupContent = `<strong>Feature ID:</strong> ${feature.properties.featureID}<br>`
            if (feature.properties.name) {
              popupContent += `<strong>Name:</strong> ${feature.properties.name}<br>`
            }
            if (feature.properties.layer) {
              popupContent += `<strong>Layer:</strong> ${feature.properties.layer}<br>`
            }
            layer.bindPopup(popupContent)
          }
        }).addTo(map)
      })
    
    function updateLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function (position) {
            var latitude = position.coords.latitude
            var longitude = position.coords.longitude
            var accuracy = position.coords.accuracy
    
            updateMap(latitude, longitude, accuracy)
    
            // Send location to Django view
            fetch('{% url "update_location" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}' // Include CSRF token
              },
              body: 'latitude=' + latitude + '&longitude=' + longitude
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  console.log('Location updated successfully')
                } else {
                  console.error('Error updating location:', data.error)
                }
              })
              .catch((error) => {
                console.error('Fetch error:', error)
              })
          },
          function (error) {
            console.error('Error getting location:', error)
          }
        )
      } else {
        console.error('Geolocation is not supported by this browser.')
      }
    }
    
    // On document load, update the location and display
    document.addEventListener('DOMContentLoaded', function () {
      {% if location %}
      var latitude = {{ location.y }}
      var longitude = {{ location.x }}
      updateMap(latitude, longitude, 0);
      {% else %}
      updateLocation()
      {% endif %}
    })
    // On page load, update the location
  </script>
{% endblock %}
