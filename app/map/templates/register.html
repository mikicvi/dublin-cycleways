{% extends 'base.html' %} {% block title %}Register{% endblock %} {% block content %}
<div class="row justify-content-center">
	<div class="col-md-5">
		<div class="card mt-5">
			<div class="card-body">
				<h2 class="card-title text-center">Register</h2>
				<form id="register-form">
					{% csrf_token %}
					<div class="form-floating mb-3">
						<input
							type="text"
							id="id_username"
							name="username"
							class="form-control"
							placeholder="Username"
							required
						/>
						<label for="id_username">Username</label>
					</div>
					<div class="form-floating mb-3">
						<input
							type="email"
							id="id_email"
							name="email"
							class="form-control"
							placeholder="Email"
							required
						/>
						<label for="id_email">Email</label>
					</div>
					<div class="form-floating mb-3">
						<input
							type="password"
							id="id_password"
							name="password"
							class="form-control"
							placeholder="Password"
							required
						/>
						<label for="id_password">Password</label>
					</div>
					<button type="submit" class="btn btn-outline-primary w-100 btn-lg">Register</button>
				</form>
				<div id="error-message" class="mt-3 text-danger" style="display: none"></div>
				<div class="mt-3 text-center">Already registered? <a href="/login/">Login</a></div>
			</div>
		</div>
	</div>
</div>
{% endblock %} {% block extra_js %}
<script>
	function sanitizeInput(input) {
		const map = {
			'&': '&amp;',
			'<': '&lt;',
			'>': '&gt;',
			'"': '&quot;',
			"'": '&#x27;',
			'/': '&#x2F;',
		};
		const reg = /[&<>"'/]/gi;
		return input.replace(reg, (match) => map[match]);
	}

	function validateEmail(email) {
		const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
		return re.test(String(email).toLowerCase());
	}

	document.getElementById('register-form').addEventListener('submit', function (e) {
		e.preventDefault();
		const username = sanitizeInput(document.getElementById('id_username').value);
		const email = sanitizeInput(document.getElementById('id_email').value);
		const password = sanitizeInput(document.getElementById('id_password').value);

		if (!validateEmail(email)) {
			document.getElementById('error-message').innerText = 'Invalid email address';
			document.getElementById('error-message').style.display = 'block';
			return;
		}

		const csrfToken = document.cookie
			.split('; ')
			.find((row) => row.startsWith('csrftoken='))
			?.split('=')[1];
		fetch('/api/register/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': csrfToken,
			},
			body: JSON.stringify({ username, email, password }),
		})
			.then((response) => {
				if (response.ok) {
					window.location.href = '/login/'; // Redirect to the login page
				} else {
					return response.json().then((data) => {
						throw new Error(data.error || 'Registration failed');
					});
				}
			})
			.catch((error) => {
				document.getElementById('error-message').innerText = error.message;
				document.getElementById('error-message').style.display = 'block';
			});
	});
</script>
{% endblock %}
